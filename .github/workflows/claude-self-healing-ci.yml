# =============================================================================
# CodeB Self-Healing CI/CD Pipeline with Claude Code CLI
# =============================================================================
# Self-Hosted Runner + Claude Code Max ($200/month) - Unlimited Tokens
# No-Deletion Principle: NEVER delete code to fix errors
# =============================================================================

name: Claude Self-Healing CI/CD

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_auto_fix:
        description: 'Skip automatic error fixing'
        required: false
        default: 'false'
        type: boolean
      max_attempts:
        description: 'Maximum fix attempts'
        required: false
        default: '5'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  MAX_FIX_ATTEMPTS: ${{ inputs.max_attempts || '5' }}
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================================================
  # Job 1: Build & Test (ubuntu-latest for initial check)
  # ===========================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      build_failed: ${{ steps.check-result.outputs.build_failed }}
      error_log: ${{ steps.capture-error.outputs.error_log }}
      error_files: ${{ steps.capture-error.outputs.error_files }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type Check
        id: typecheck
        continue-on-error: true
        run: npm run typecheck 2>&1 | tee typecheck.log || echo "TYPECHECK_FAILED"

      - name: Lint
        id: lint
        continue-on-error: true
        run: npm run lint 2>&1 | tee lint.log || echo "LINT_FAILED"

      - name: Build
        id: build
        continue-on-error: true
        run: npm run build 2>&1 | tee build.log || echo "BUILD_FAILED"

      - name: Test
        id: test
        continue-on-error: true
        run: npm run test 2>&1 | tee test.log || echo "TEST_FAILED"

      - name: Capture Error Logs
        id: capture-error
        run: |
          # Combine all error logs
          echo "=== BUILD ERROR SUMMARY ===" > error_summary.log
          echo "Timestamp: $(date -u)" >> error_summary.log
          echo "" >> error_summary.log

          BUILD_FAILED="false"
          ERROR_FILES=""

          if grep -q "TYPECHECK_FAILED\|error TS" typecheck.log 2>/dev/null; then
            echo "### TypeScript Errors ###" >> error_summary.log
            cat typecheck.log >> error_summary.log
            echo "" >> error_summary.log
            BUILD_FAILED="true"
            # Extract error files
            ERROR_FILES="$ERROR_FILES $(grep -oE "[^ ]+\.tsx?:[0-9]+" typecheck.log | cut -d: -f1 | sort -u | tr '\n' ' ')"
          fi

          if grep -q "LINT_FAILED\|error\|âœ–" lint.log 2>/dev/null; then
            echo "### ESLint Errors ###" >> error_summary.log
            cat lint.log >> error_summary.log
            echo "" >> error_summary.log
            BUILD_FAILED="true"
            ERROR_FILES="$ERROR_FILES $(grep -oE "^[^ ]+\.(ts|tsx|js|jsx)" lint.log | sort -u | tr '\n' ' ')"
          fi

          if grep -q "BUILD_FAILED\|Error:" build.log 2>/dev/null; then
            echo "### Build Errors ###" >> error_summary.log
            cat build.log >> error_summary.log
            echo "" >> error_summary.log
            BUILD_FAILED="true"
          fi

          if grep -q "TEST_FAILED\|FAIL\|failed" test.log 2>/dev/null; then
            echo "### Test Errors ###" >> error_summary.log
            cat test.log >> error_summary.log
            BUILD_FAILED="true"
          fi

          # Save outputs
          echo "build_failed=$BUILD_FAILED" >> $GITHUB_OUTPUT
          echo "error_files=$(echo $ERROR_FILES | xargs)" >> $GITHUB_OUTPUT

          # Base64 encode for multi-line support
          ERROR_LOG=$(cat error_summary.log | base64 -w 0)
          echo "error_log=$ERROR_LOG" >> $GITHUB_OUTPUT

      - name: Check Result
        id: check-result
        run: |
          if [ "${{ steps.capture-error.outputs.build_failed }}" == "true" ]; then
            echo "build_failed=true" >> $GITHUB_OUTPUT
            echo "::error::Build failed - errors detected"
          else
            echo "build_failed=false" >> $GITHUB_OUTPUT
            echo "::notice::All checks passed!"
          fi

      - name: Upload Error Logs
        if: steps.check-result.outputs.build_failed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: "*.log"
          retention-days: 7

  # ===========================================================================
  # Job 2: Auto-Fix with Claude Code CLI (Self-Hosted Runner)
  # ===========================================================================
  claude-auto-fix:
    name: Claude Code Auto-Fix
    needs: build
    if: |
      needs.build.outputs.build_failed == 'true' &&
      inputs.skip_auto_fix != 'true' &&
      github.event_name == 'push'
    runs-on: [self-hosted, codeb, claude-code]
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Git
        run: |
          git config --local user.email "claude-code[bot]@users.noreply.github.com"
          git config --local user.name "Claude Code Bot"

      - name: Decode Error Log
        id: decode-error
        run: |
          echo "${{ needs.build.outputs.error_log }}" | base64 -d > error_summary.log
          echo "=== Error Summary ==="
          cat error_summary.log
          echo ""
          echo "Error files: ${{ needs.build.outputs.error_files }}"

      - name: Claude Code Auto-Fix Loop
        id: claude-fix
        env:
          MAX_ATTEMPTS: ${{ env.MAX_FIX_ATTEMPTS }}
        run: |
          ATTEMPT=0
          SUCCESS=false

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "=== Fix Attempt $ATTEMPT of $MAX_ATTEMPTS ==="

            # Create fix prompt with No-Deletion Principle
            cat > fix_prompt.txt << 'PROMPT_EOF'
          ë‹¤ìŒ ë¹Œë“œ ì—ëŸ¬ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.

          ## ì ˆëŒ€ ê¸ˆì§€ ê·œì¹™ (No-Deletion Principle)
          1. ì½”ë“œë¥¼ ì‚­ì œí•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì§€ ë§ˆì„¸ìš”
          2. í…ŒìŠ¤íŠ¸ë¥¼ skipí•˜ê±°ë‚˜ ì œê±°í•˜ì§€ ë§ˆì„¸ìš”
          3. @ts-ignore, @ts-nocheck, @ts-expect-error ì¶”ê°€ ê¸ˆì§€
          4. eslint-disable, eslint-disable-next-line ì¶”ê°€ ê¸ˆì§€
          5. any íƒ€ìž… ì‚¬ìš© ê¸ˆì§€ (as any, : any)
          6. .skip(), .only() ì‚¬ìš© ê¸ˆì§€
          7. || true, || exit 0 ìœ¼ë¡œ ì—ëŸ¬ ë¬´ì‹œ ê¸ˆì§€
          8. continue-on-error ì‚¬ìš© ê¸ˆì§€

          ## í—ˆìš©ë˜ëŠ” ìˆ˜ì •
          1. íƒ€ìž… ì •ì˜ ì¶”ê°€/ìˆ˜ì • (interface, type ìƒì„±)
          2. ëˆ„ë½ëœ import ì¶”ê°€
          3. null/undefined ì²´í¬ ì¶”ê°€
          4. ì˜¬ë°”ë¥¸ íƒ€ìž… ìºìŠ¤íŒ… (as íŠ¹ì •íƒ€ìž…, any ì œì™¸)
          5. ë¡œì§ ë²„ê·¸ ìˆ˜ì •
          6. í…ŒìŠ¤íŠ¸ assertion ìˆ˜ì • (ê¸°ëŒ€ê°’ì´ ìž˜ëª»ëœ ê²½ìš°)
          7. ëˆ„ë½ëœ return ì¶”ê°€
          8. ì¸í„°íŽ˜ì´ìŠ¤ ìƒì„±

          ## ì—ëŸ¬ ë¡œê·¸
          PROMPT_EOF

            cat error_summary.log >> fix_prompt.txt

            echo "" >> fix_prompt.txt
            echo "ê° ì—ëŸ¬ì— ëŒ€í•´ íŒŒì¼ì„ ì½ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”." >> fix_prompt.txt

            # Run Claude Code CLI
            echo "Running Claude Code CLI..."
            claude --print -p "$(cat fix_prompt.txt)" --allowedTools "Read,Edit,Write,Glob,Grep" 2>&1 | tee claude_output.log || true

            # Check if any files were modified
            if git diff --quiet; then
              echo "No changes made by Claude"
              continue
            fi

            # Validate fix (No-Deletion Check)
            echo "=== Validating Fix ==="

            DELETIONS=$(git diff --numstat | awk '{ sum += $2 } END { print sum+0 }')
            ADDITIONS=$(git diff --numstat | awk '{ sum += $1 } END { print sum+0 }')

            echo "Additions: $ADDITIONS, Deletions: $DELETIONS"

            if [ "$DELETIONS" -gt "$ADDITIONS" ]; then
              echo "::error::Fix rejected: More deletions ($DELETIONS) than additions ($ADDITIONS)"
              git checkout -- .
              continue
            fi

            # Check forbidden patterns
            if git diff | grep -E "@ts-ignore|@ts-nocheck|@ts-expect-error|eslint-disable|\.skip\(|\.only\(|: any|as any|\|\| true|\|\| exit" > /dev/null 2>&1; then
              echo "::error::Fix rejected: Contains forbidden patterns"
              git diff | grep -E "@ts-ignore|@ts-nocheck|@ts-expect-error|eslint-disable|\.skip\(|\.only\(|: any|as any|\|\| true|\|\| exit" || true
              git checkout -- .
              continue
            fi

            echo "Fix validation passed!"

            # Re-test build
            echo "=== Re-testing Build ==="
            npm run typecheck 2>&1 | tee retest_typecheck.log && \
            npm run lint 2>&1 | tee retest_lint.log && \
            npm run build 2>&1 | tee retest_build.log && \
            npm run test 2>&1 | tee retest_test.log

            if [ $? -eq 0 ]; then
              echo "::notice::Build successful after fix!"
              SUCCESS=true
              break
            else
              echo "Build still failing, updating error log..."
              cat retest_*.log > error_summary.log
            fi
          done

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT

      - name: Commit and Push Fix
        if: steps.claude-fix.outputs.success == 'true'
        run: |
          git add -A
          git commit -m "fix: auto-fix build errors (attempt ${{ steps.claude-fix.outputs.attempts }})

          Applied AI-assisted fixes using Claude Code CLI.

          Validation:
          - No-Deletion Principle: Passed
          - Forbidden Patterns: None detected
          - Build/Test: Passed

          ðŸ¤– Generated by Claude Code Self-Healing CI/CD
          Co-Authored-By: Claude <noreply@anthropic.com>"

          git push origin ${{ github.ref_name }}

      - name: Create Fix Summary
        if: always()
        run: |
          echo "## Claude Code Auto-Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Success | ${{ steps.claude-fix.outputs.success }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Attempts | ${{ steps.claude-fix.outputs.attempts }} / ${{ env.MAX_FIX_ATTEMPTS }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Error Files | ${{ needs.build.outputs.error_files }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 3: Docker Build (after successful build or fix)
  # ===========================================================================
  docker:
    name: Build & Push Docker Image
    needs: [build, claude-auto-fix]
    if: |
      always() &&
      (needs.build.outputs.build_failed != 'true' || needs.claude-auto-fix.outputs.success == 'true') &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Job 4: Deploy to Server (Self-Hosted Runner)
  # ===========================================================================
  deploy:
    name: Deploy to Server
    needs: [docker]
    if: github.ref == 'refs/heads/main'
    runs-on: [self-hosted, codeb]
    environment: production

    steps:
      - name: Pull and Deploy
        run: |
          cd /opt/codeb/projects/${{ github.event.repository.name }} || mkdir -p /opt/codeb/projects/${{ github.event.repository.name }}

          # Pull latest image
          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

          # Deploy with compose if exists
          if [ -f "docker-compose.yml" ] || [ -f "compose.yml" ]; then
            podman-compose pull
            podman-compose up -d --remove-orphans
          else
            # Single container deployment
            podman stop ${{ github.event.repository.name }} 2>/dev/null || true
            podman rm ${{ github.event.repository.name }} 2>/dev/null || true
            podman run -d --name ${{ github.event.repository.name }} \
              --restart unless-stopped \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          fi

      - name: Health Check
        run: |
          echo "Waiting for service to start..."
          sleep 10

          # Try health check
          for i in {1..5}; do
            if curl -sf http://localhost:3000/health > /dev/null 2>&1; then
              echo "::notice::Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

          echo "::error::Health check failed after 5 attempts"
          exit 1

      - name: Deployment Summary
        if: success()
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: \`${{ secrets.SERVER_HOST || 'self-hosted' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
