# =============================================================================
# CodeB Self-Healing CI/CD Pipeline - Complete Edition
# =============================================================================
# Enhanced version with Preview Environments, Slack Notifications, and Metrics
# Self-Hosted Runner + Claude Code Max ($200/month) - Unlimited Tokens
# No-Deletion Principle: NEVER delete code to fix errors
# =============================================================================

name: Self-Healing CI/CD Complete

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_auto_fix:
        description: 'Skip automatic error fixing'
        required: false
        default: 'false'
        type: boolean
      max_attempts:
        description: 'Maximum fix attempts'
        required: false
        default: '5'
        type: string
      create_preview:
        description: 'Create preview environment'
        required: false
        default: 'true'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  MAX_FIX_ATTEMPTS: ${{ inputs.max_attempts || '5' }}
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # ===========================================================================
  # Job 1: Build & Test with Enhanced Error Detection
  # ===========================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      build_failed: ${{ steps.check-result.outputs.build_failed }}
      error_log: ${{ steps.capture-error.outputs.error_log }}
      error_files: ${{ steps.capture-error.outputs.error_files }}
      error_type: ${{ steps.classify-errors.outputs.error_type }}
      fix_complexity: ${{ steps.classify-errors.outputs.fix_complexity }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type Check
        id: typecheck
        continue-on-error: true
        run: npm run typecheck 2>&1 | tee typecheck.log || echo "TYPECHECK_FAILED"

      - name: Lint
        id: lint
        continue-on-error: true
        run: npm run lint 2>&1 | tee lint.log || echo "LINT_FAILED"

      - name: Build
        id: build
        continue-on-error: true
        run: npm run build 2>&1 | tee build.log || echo "BUILD_FAILED"

      - name: Test
        id: test
        continue-on-error: true
        run: npm run test:ci 2>&1 | tee test.log || echo "TEST_FAILED"

      - name: Capture Error Logs
        id: capture-error
        run: |
          echo "=== BUILD ERROR SUMMARY ===" > error_summary.log
          echo "Timestamp: $(date -u)" >> error_summary.log
          echo "Commit: ${{ github.sha }}" >> error_summary.log
          echo "Branch: ${{ github.ref_name }}" >> error_summary.log
          echo "" >> error_summary.log

          BUILD_FAILED="false"
          ERROR_FILES=""

          if grep -q "TYPECHECK_FAILED\|error TS" typecheck.log 2>/dev/null; then
            echo "### TypeScript Errors ###" >> error_summary.log
            cat typecheck.log >> error_summary.log
            echo "" >> error_summary.log
            BUILD_FAILED="true"
            ERROR_FILES="$ERROR_FILES $(grep -oE "[^ ]+\.tsx?:[0-9]+" typecheck.log | cut -d: -f1 | sort -u | tr '\n' ' ')"
          fi

          if grep -q "LINT_FAILED\|error\|âœ–" lint.log 2>/dev/null; then
            echo "### ESLint Errors ###" >> error_summary.log
            cat lint.log >> error_summary.log
            echo "" >> error_summary.log
            BUILD_FAILED="true"
            ERROR_FILES="$ERROR_FILES $(grep -oE "^[^ ]+\.(ts|tsx|js|jsx)" lint.log | sort -u | tr '\n' ' ')"
          fi

          if grep -q "BUILD_FAILED\|Error:" build.log 2>/dev/null; then
            echo "### Build Errors ###" >> error_summary.log
            cat build.log >> error_summary.log
            echo "" >> error_summary.log
            BUILD_FAILED="true"
          fi

          if grep -q "TEST_FAILED\|FAIL\|failed" test.log 2>/dev/null; then
            echo "### Test Errors ###" >> error_summary.log
            cat test.log >> error_summary.log
            BUILD_FAILED="true"
          fi

          echo "build_failed=$BUILD_FAILED" >> $GITHUB_OUTPUT
          echo "error_files=$(echo $ERROR_FILES | xargs)" >> $GITHUB_OUTPUT

          ERROR_LOG=$(cat error_summary.log | base64 -w 0)
          echo "error_log=$ERROR_LOG" >> $GITHUB_OUTPUT

      - name: Classify Errors
        id: classify-errors
        if: steps.capture-error.outputs.build_failed == 'true'
        run: |
          ERROR_TYPE="unknown"
          FIX_COMPLEXITY="medium"

          # Classify error type
          if grep -q "error TS" error_summary.log; then
            ERROR_TYPE="typescript"
            FIX_COMPLEXITY="low"
          elif grep -q "Module not found\|Cannot find module" error_summary.log; then
            ERROR_TYPE="import"
            FIX_COMPLEXITY="low"
          elif grep -q "eslint" error_summary.log; then
            ERROR_TYPE="lint"
            FIX_COMPLEXITY="low"
          elif grep -q "FAIL.*test" error_summary.log; then
            ERROR_TYPE="test"
            FIX_COMPLEXITY="medium"
          elif grep -q "build.*failed" error_summary.log; then
            ERROR_TYPE="build"
            FIX_COMPLEXITY="high"
          fi

          echo "error_type=$ERROR_TYPE" >> $GITHUB_OUTPUT
          echo "fix_complexity=$FIX_COMPLEXITY" >> $GITHUB_OUTPUT

      - name: Check Result
        id: check-result
        run: |
          if [ "${{ steps.capture-error.outputs.build_failed }}" == "true" ]; then
            echo "build_failed=true" >> $GITHUB_OUTPUT
            echo "::error::Build failed - ${{ steps.classify-errors.outputs.error_type }} errors detected"
          else
            echo "build_failed=false" >> $GITHUB_OUTPUT
            echo "::notice::All checks passed!"
          fi

      - name: Upload Error Logs
        if: steps.check-result.outputs.build_failed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_number }}
          path: "*.log"
          retention-days: 7

  # ===========================================================================
  # Job 2: Auto-Fix with Claude Code CLI (Enhanced)
  # ===========================================================================
  claude-auto-fix:
    name: Claude Code Auto-Fix
    needs: build
    if: |
      needs.build.outputs.build_failed == 'true' &&
      inputs.skip_auto_fix != 'true' &&
      github.event_name == 'push'
    runs-on: [self-hosted, codeb, claude-code]
    permissions:
      contents: write
      pull-requests: write
    outputs:
      fix_success: ${{ steps.claude-fix.outputs.success }}
      fix_attempts: ${{ steps.claude-fix.outputs.attempts }}
      fix_summary: ${{ steps.create-summary.outputs.summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Git
        run: |
          git config --local user.email "claude-code[bot]@users.noreply.github.com"
          git config --local user.name "Claude Code Bot"

      - name: Decode Error Log
        id: decode-error
        run: |
          echo "${{ needs.build.outputs.error_log }}" | base64 -d > error_summary.log
          echo "=== Error Summary ==="
          cat error_summary.log
          echo ""
          echo "Error Type: ${{ needs.build.outputs.error_type }}"
          echo "Fix Complexity: ${{ needs.build.outputs.fix_complexity }}"
          echo "Error Files: ${{ needs.build.outputs.error_files }}"

      - name: Claude Code Auto-Fix Loop
        id: claude-fix
        env:
          MAX_ATTEMPTS: ${{ env.MAX_FIX_ATTEMPTS }}
          ERROR_TYPE: ${{ needs.build.outputs.error_type }}
        run: |
          ATTEMPT=0
          SUCCESS=false
          FIX_CHANGES=""

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "=== Fix Attempt $ATTEMPT of $MAX_ATTEMPTS ==="

            # Create context-aware fix prompt
            cat > fix_prompt.txt << 'PROMPT_EOF'
          ë‹¤ìŒ $ERROR_TYPE ë¹Œë“œ ì—ëŸ¬ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.

          ## ì ˆëŒ€ ê¸ˆì§€ ê·œì¹™ (No-Deletion Principle)
          1. ì½”ë“œë¥¼ ì‚­ì œí•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì§€ ë§ˆì„¸ìš”
          2. í…ŒìŠ¤íŠ¸ë¥¼ skipí•˜ê±°ë‚˜ ì œê±°í•˜ì§€ ë§ˆì„¸ìš”
          3. @ts-ignore, @ts-nocheck, @ts-expect-error ì¶”ê°€ ê¸ˆì§€
          4. eslint-disable, eslint-disable-next-line ì¶”ê°€ ê¸ˆì§€
          5. any íƒ€ìž… ì‚¬ìš© ê¸ˆì§€ (as any, : any)
          6. .skip(), .only() ì‚¬ìš© ê¸ˆì§€
          7. || true, || exit 0 ìœ¼ë¡œ ì—ëŸ¬ ë¬´ì‹œ ê¸ˆì§€
          8. continue-on-error ì‚¬ìš© ê¸ˆì§€

          ## í—ˆìš©ë˜ëŠ” ìˆ˜ì •
          1. íƒ€ìž… ì •ì˜ ì¶”ê°€/ìˆ˜ì • (interface, type ìƒì„±)
          2. ëˆ„ë½ëœ import ì¶”ê°€
          3. null/undefined ì²´í¬ ì¶”ê°€
          4. ì˜¬ë°”ë¥¸ íƒ€ìž… ìºìŠ¤íŒ… (as íŠ¹ì •íƒ€ìž…, any ì œì™¸)
          5. ë¡œì§ ë²„ê·¸ ìˆ˜ì •
          6. í…ŒìŠ¤íŠ¸ assertion ìˆ˜ì • (ê¸°ëŒ€ê°’ì´ ìž˜ëª»ëœ ê²½ìš°)
          7. ëˆ„ë½ëœ return ì¶”ê°€
          8. ì¸í„°íŽ˜ì´ìŠ¤ ìƒì„±

          ## ì—ëŸ¬ ë¡œê·¸
          PROMPT_EOF

            cat error_summary.log >> fix_prompt.txt

            echo "" >> fix_prompt.txt
            echo "ê° ì—ëŸ¬ì— ëŒ€í•´ íŒŒì¼ì„ ì½ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”." >> fix_prompt.txt
            echo "ìˆ˜ì • í›„ ë³€ê²½ ì‚¬í•­ì„ ìš”ì•½í•´ì£¼ì„¸ìš”." >> fix_prompt.txt

            # Run Claude Code CLI
            echo "Running Claude Code CLI..."
            claude --print -p "$(cat fix_prompt.txt)" --allowedTools "Read,Edit,Write,Glob,Grep" 2>&1 | tee claude_output.log || true

            # Check if any files were modified
            if git diff --quiet; then
              echo "No changes made by Claude"
              continue
            fi

            # Validate fix (No-Deletion Check)
            echo "=== Validating Fix ==="

            DELETIONS=$(git diff --numstat | awk '{ sum += $2 } END { print sum+0 }')
            ADDITIONS=$(git diff --numstat | awk '{ sum += $1 } END { print sum+0 }')

            echo "Additions: $ADDITIONS, Deletions: $DELETIONS"

            if [ "$DELETIONS" -gt "$ADDITIONS" ]; then
              echo "::error::Fix rejected: More deletions ($DELETIONS) than additions ($ADDITIONS)"
              git checkout -- .
              continue
            fi

            # Check forbidden patterns
            if git diff | grep -E "@ts-ignore|@ts-nocheck|@ts-expect-error|eslint-disable|\.skip\(|\.only\(|: any|as any|\|\| true|\|\| exit" > /dev/null 2>&1; then
              echo "::error::Fix rejected: Contains forbidden patterns"
              git diff | grep -E "@ts-ignore|@ts-nocheck|@ts-expect-error|eslint-disable|\.skip\(|\.only\(|: any|as any|\|\| true|\|\| exit" || true
              git checkout -- .
              continue
            fi

            echo "Fix validation passed!"

            # Re-test build
            echo "=== Re-testing Build ==="
            npm run typecheck 2>&1 | tee retest_typecheck.log && \
            npm run lint 2>&1 | tee retest_lint.log && \
            npm run build 2>&1 | tee retest_build.log && \
            npm run test:ci 2>&1 | tee retest_test.log

            if [ $? -eq 0 ]; then
              echo "::notice::Build successful after fix!"
              SUCCESS=true
              FIX_CHANGES=$(git diff --stat)
              break
            else
              echo "Build still failing, updating error log..."
              cat retest_*.log > error_summary.log
            fi
          done

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$FIX_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit and Push Fix
        if: steps.claude-fix.outputs.success == 'true'
        run: |
          git add -A
          git commit -m "fix: auto-fix ${{ needs.build.outputs.error_type }} errors (attempt ${{ steps.claude-fix.outputs.attempts }})

          Applied AI-assisted fixes using Claude Code CLI.

          Error Type: ${{ needs.build.outputs.error_type }}
          Fix Complexity: ${{ needs.build.outputs.fix_complexity }}
          Attempts: ${{ steps.claude-fix.outputs.attempts }}/${{ env.MAX_FIX_ATTEMPTS }}

          Changes:
          ${{ steps.claude-fix.outputs.changes }}

          Validation:
          - No-Deletion Principle: Passed
          - Forbidden Patterns: None detected
          - Build/Test: Passed

          ðŸ¤– Generated by Claude Code Self-Healing CI/CD
          Co-Authored-By: Claude <noreply@anthropic.com>"

          git push origin ${{ github.ref_name }}

      - name: Create Fix Summary
        id: create-summary
        if: always()
        run: |
          SUMMARY="## ðŸ¤– Claude Code Auto-Fix Summary\n\n"
          SUMMARY="$SUMMARY| Metric | Value |\n"
          SUMMARY="$SUMMARY|--------|-------|\n"
          SUMMARY="$SUMMARY| Success | ${{ steps.claude-fix.outputs.success }} |\n"
          SUMMARY="$SUMMARY| Attempts | ${{ steps.claude-fix.outputs.attempts }}/${{ env.MAX_FIX_ATTEMPTS }} |\n"
          SUMMARY="$SUMMARY| Error Type | ${{ needs.build.outputs.error_type }} |\n"
          SUMMARY="$SUMMARY| Complexity | ${{ needs.build.outputs.fix_complexity }} |\n"
          SUMMARY="$SUMMARY| Files Changed | $(echo '${{ steps.claude-fix.outputs.changes }}' | wc -l) |\n"

          echo -e "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

      - name: Notify Slack (Fix Success)
        if: steps.claude-fix.outputs.success == 'true' && env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âœ… Self-Healing CI/CD: Build fixed automatically",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Self-Healing CI/CD Success*\n\n:white_check_mark: Build errors automatically fixed by Claude Code"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}"},
                    {"type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}"},
                    {"type": "mrkdwn", "text": "*Error Type:*\n${{ needs.build.outputs.error_type }}"},
                    {"type": "mrkdwn", "text": "*Attempts:*\n${{ steps.claude-fix.outputs.attempts }}/${{ env.MAX_FIX_ATTEMPTS }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "View Workflow"},
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Notify Slack (Fix Failed)
        if: steps.claude-fix.outputs.success != 'true' && env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âš ï¸ Self-Healing CI/CD: Manual intervention required",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Self-Healing CI/CD Failed*\n\n:warning: Unable to automatically fix build errors"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}"},
                    {"type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}"},
                    {"type": "mrkdwn", "text": "*Error Type:*\n${{ needs.build.outputs.error_type }}"},
                    {"type": "mrkdwn", "text": "*Attempts:*\n${{ steps.claude-fix.outputs.attempts }}/${{ env.MAX_FIX_ATTEMPTS }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "View Errors"},
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  # ===========================================================================
  # Job 3: Preview Environment (PR only)
  # ===========================================================================
  preview:
    name: Deploy Preview Environment
    needs: [build, claude-auto-fix]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      (needs.build.outputs.build_failed != 'true' || needs.claude-auto-fix.outputs.fix_success == 'true') &&
      inputs.create_preview != 'false'
    runs-on: [self-hosted, codeb]
    environment:
      name: preview-pr-${{ github.event.pull_request.number }}
      url: https://pr-${{ github.event.pull_request.number }}.preview.codeb.dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Preview Image
        run: |
          podman build -t preview-${{ github.event.pull_request.number }}:latest .

      - name: Deploy Preview
        run: |
          podman stop preview-${{ github.event.pull_request.number }} 2>/dev/null || true
          podman rm preview-${{ github.event.pull_request.number }} 2>/dev/null || true
          podman run -d \
            --name preview-${{ github.event.pull_request.number }} \
            --restart unless-stopped \
            -p $((3000 + ${{ github.event.pull_request.number }})):3000 \
            -e NODE_ENV=preview \
            -e PR_NUMBER=${{ github.event.pull_request.number }} \
            preview-${{ github.event.pull_request.number }}:latest

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://pr-${prNumber}.preview.codeb.dev`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸš€ Preview Environment Ready\n\n` +
                    `Your preview environment is deployed and ready!\n\n` +
                    `**Preview URL:** ${previewUrl}\n\n` +
                    `This preview will be automatically deleted when the PR is closed.`
            });

  # ===========================================================================
  # Job 4: Docker Build (after successful build or fix)
  # ===========================================================================
  docker:
    name: Build & Push Docker Image
    needs: [build, claude-auto-fix]
    if: |
      always() &&
      (needs.build.outputs.build_failed != 'true' || needs.claude-auto-fix.outputs.fix_success == 'true') &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Job 5: Deploy to Production
  # ===========================================================================
  deploy:
    name: Deploy to Production
    needs: [docker]
    if: github.ref == 'refs/heads/main'
    runs-on: [self-hosted, codeb]
    environment: production

    steps:
      - name: Pull and Deploy
        run: |
          cd /opt/codeb/projects/${{ github.event.repository.name }} || mkdir -p /opt/codeb/projects/${{ github.event.repository.name }}

          podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

          if [ -f "docker-compose.yml" ] || [ -f "compose.yml" ]; then
            podman-compose pull
            podman-compose up -d --remove-orphans
          else
            podman stop ${{ github.event.repository.name }} 2>/dev/null || true
            podman rm ${{ github.event.repository.name }} 2>/dev/null || true
            podman run -d --name ${{ github.event.repository.name }} \
              --restart unless-stopped \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          fi

      - name: Health Check
        run: |
          echo "Waiting for service to start..."
          sleep 10

          for i in {1..5}; do
            if curl -sf http://localhost:3000/health > /dev/null 2>&1; then
              echo "::notice::Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

          echo "::error::Health check failed after 5 attempts"
          exit 1

      - name: Deployment Summary
        if: success()
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: \`${{ secrets.SERVER_HOST || 'self-hosted' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack (Deployment Success)
        if: success() && env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš€ Production Deployment Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Complete*\n\n:rocket: ${{ github.repository }} deployed successfully"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Environment:*\nProduction"},
                    {"type": "mrkdwn", "text": "*Image:*\n${{ env.IMAGE_NAME }}:latest"},
                    {"type": "mrkdwn", "text": "*Commit:*\n${{ github.sha }}"},
                    {"type": "mrkdwn", "text": "*Author:*\n${{ github.actor }}"}
                  ]
                }
              ]
            }

  # ===========================================================================
  # Job 6: Collect Metrics
  # ===========================================================================
  metrics:
    name: Collect Self-Healing Metrics
    needs: [build, claude-auto-fix, deploy]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Calculate Success Rate
        id: metrics
        run: |
          TOTAL_RUNS=$(gh api "/repos/${{ github.repository }}/actions/workflows/self-healing-complete.yml/runs" --jq '.total_count')
          SUCCESSFUL_FIXES=$(gh api "/repos/${{ github.repository }}/actions/workflows/self-healing-complete.yml/runs?status=success" --jq '.total_count')

          SUCCESS_RATE=$(echo "scale=2; ($SUCCESSFUL_FIXES / $TOTAL_RUNS) * 100" | bc)

          echo "total_runs=$TOTAL_RUNS" >> $GITHUB_OUTPUT
          echo "successful_fixes=$SUCCESSFUL_FIXES" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT

      - name: Create Metrics Summary
        run: |
          echo "## ðŸ“Š Self-Healing CI/CD Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Runs | ${{ steps.metrics.outputs.total_runs }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Successful Fixes | ${{ steps.metrics.outputs.successful_fixes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Success Rate | ${{ steps.metrics.outputs.success_rate }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| This Run - Build Failed | ${{ needs.build.outputs.build_failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| This Run - Fix Success | ${{ needs.claude-auto-fix.outputs.fix_success }} |" >> $GITHUB_STEP_SUMMARY
          echo "| This Run - Fix Attempts | ${{ needs.claude-auto-fix.outputs.fix_attempts }} |" >> $GITHUB_STEP_SUMMARY
