# =============================================================================
# CodeB Self-Healing CI/CD Pipeline
# =============================================================================
# ëª©ì : ë¹Œë“œ ì—ëŸ¬ ë°œìƒ ì‹œ Claude Codeë¡œ ìë™ ìˆ˜ì • í›„ ì¬ì‹œë„
# í•µì‹¬ ì›ì¹™: ì ˆëŒ€ ì½”ë“œë¥¼ ì‚­ì œí•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì§€ ì•ŠìŒ
# ì‘ì„±ì¼: 2025-01-10
# ë²„ì „: 1.0.0
# =============================================================================

name: Self-Healing CI/CD

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_auto_fix:
        description: 'Skip automatic error fixing'
        required: false
        default: 'false'
        type: boolean

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ - ê°™ì€ ë¸Œëœì¹˜ì—ì„œ í•˜ë‚˜ì˜ ì›Œí¬í”Œë¡œìš°ë§Œ ì‹¤í–‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  MAX_FIX_ATTEMPTS: 5
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================================================
  # Job 1: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # ===========================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build.outcome }}
      test_status: ${{ steps.test.outcome }}
      error_log: ${{ steps.capture-error.outputs.error_log }}
      should_auto_fix: ${{ steps.check-auto-fix.outputs.should_fix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type Check
        id: typecheck
        continue-on-error: true
        run: npm run typecheck 2>&1 | tee typecheck.log

      - name: Lint
        id: lint
        continue-on-error: true
        run: npm run lint 2>&1 | tee lint.log

      - name: Build
        id: build
        continue-on-error: true
        run: npm run build 2>&1 | tee build.log

      - name: Test
        id: test
        continue-on-error: true
        run: npm run test 2>&1 | tee test.log

      # ì—ëŸ¬ ë¡œê·¸ ìº¡ì²˜
      - name: Capture Error Logs
        id: capture-error
        if: steps.typecheck.outcome == 'failure' || steps.lint.outcome == 'failure' || steps.build.outcome == 'failure' || steps.test.outcome == 'failure'
        run: |
          echo "=== ERROR SUMMARY ===" > error_summary.log
          echo "" >> error_summary.log

          if [ "${{ steps.typecheck.outcome }}" == "failure" ]; then
            echo "### TypeScript Errors ###" >> error_summary.log
            cat typecheck.log >> error_summary.log
            echo "" >> error_summary.log
          fi

          if [ "${{ steps.lint.outcome }}" == "failure" ]; then
            echo "### Lint Errors ###" >> error_summary.log
            cat lint.log >> error_summary.log
            echo "" >> error_summary.log
          fi

          if [ "${{ steps.build.outcome }}" == "failure" ]; then
            echo "### Build Errors ###" >> error_summary.log
            cat build.log >> error_summary.log
            echo "" >> error_summary.log
          fi

          if [ "${{ steps.test.outcome }}" == "failure" ]; then
            echo "### Test Errors ###" >> error_summary.log
            cat test.log >> error_summary.log
          fi

          # ì—ëŸ¬ ë¡œê·¸ë¥¼ base64ë¡œ ì¸ì½”ë”© (ë©€í‹°ë¼ì¸ ì¶œë ¥ ì²˜ë¦¬)
          ERROR_LOG=$(cat error_summary.log | base64 -w 0)
          echo "error_log=$ERROR_LOG" >> $GITHUB_OUTPUT

      - name: Check if Auto-Fix should run
        id: check-auto-fix
        run: |
          if [ "${{ inputs.skip_auto_fix }}" == "true" ]; then
            echo "should_fix=false" >> $GITHUB_OUTPUT
          elif [ "${{ steps.typecheck.outcome }}" == "failure" ] || \
               [ "${{ steps.lint.outcome }}" == "failure" ] || \
               [ "${{ steps.build.outcome }}" == "failure" ] || \
               [ "${{ steps.test.outcome }}" == "failure" ]; then
            echo "should_fix=true" >> $GITHUB_OUTPUT
          else
            echo "should_fix=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Error Logs
        if: steps.capture-error.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            *.log
          retention-days: 7

      # ëª¨ë“  ì²´í¬ í†µê³¼ ì‹œ ì„±ê³µ
      - name: Final Status Check
        if: steps.typecheck.outcome == 'success' && steps.lint.outcome == 'success' && steps.build.outcome == 'success' && steps.test.outcome == 'success'
        run: echo "âœ… All checks passed!"

  # ===========================================================================
  # Job 2: ìë™ ì—ëŸ¬ ìˆ˜ì • (Claude Code ì—°ë™)
  # ===========================================================================
  auto-fix:
    name: Auto Fix with AI
    needs: build
    if: needs.build.outputs.should_auto_fix == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Error Logs
        uses: actions/download-artifact@v4
        with:
          name: error-logs
          path: ./error-logs

      - name: Setup Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Parse Error Logs
        id: parse-errors
        run: |
          # ì—ëŸ¬ ë¡œê·¸ ë””ì½”ë”©
          ERROR_LOG=$(echo "${{ needs.build.outputs.error_log }}" | base64 -d)
          echo "Decoded error log:"
          echo "$ERROR_LOG"

          # ì—ëŸ¬ ìœ í˜• ë¶„ë¥˜
          ERROR_TYPES=""
          if echo "$ERROR_LOG" | grep -q "TypeScript\|TS[0-9]"; then
            ERROR_TYPES="$ERROR_TYPES typescript"
          fi
          if echo "$ERROR_LOG" | grep -q "eslint\|ESLint"; then
            ERROR_TYPES="$ERROR_TYPES lint"
          fi
          if echo "$ERROR_LOG" | grep -q "Cannot find module\|Module not found"; then
            ERROR_TYPES="$ERROR_TYPES import"
          fi
          if echo "$ERROR_LOG" | grep -q "test\|Test\|expect\|jest"; then
            ERROR_TYPES="$ERROR_TYPES test"
          fi

          echo "error_types=$ERROR_TYPES" >> $GITHUB_OUTPUT

      # =========================================================================
      # AI ìˆ˜ì • ìš”ì²­ (GitHub Copilot API ì‚¬ìš©)
      # =========================================================================
      - name: Request AI Fix (GitHub Copilot)
        id: ai-fix
        env:
          ERROR_LOG: ${{ needs.build.outputs.error_log }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ì—ëŸ¬ ë¡œê·¸ ë””ì½”ë”©
          ERROR_LOG_DECODED=$(echo "$ERROR_LOG" | base64 -d)

          # GitHub Copilot API ìš”ì²­ í˜ì´ë¡œë“œ ìƒì„±
          cat > fix_request.json << PAYLOAD_EOF
          {
            "messages": [
              {
                "role": "system",
                "content": "ë‹¹ì‹ ì€ ì½”ë“œ ë¹Œë“œ ì—ëŸ¬ë¥¼ ìˆ˜ì •í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\n## ì ˆëŒ€ ê¸ˆì§€ ê·œì¹™ (ì½”ë“œ í’ˆì§ˆ)\n1. âŒ ì½”ë“œë¥¼ ì‚­ì œí•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì§€ ë§ˆì„¸ìš”\n2. âŒ í…ŒìŠ¤íŠ¸ë¥¼ skipí•˜ê±°ë‚˜ ì œê±°í•˜ì§€ ë§ˆì„¸ìš”\n3. âŒ @ts-ignore, @ts-nocheck ì¶”ê°€ ê¸ˆì§€\n4. âŒ eslint-disable ì¶”ê°€ ê¸ˆì§€\n5. âŒ any íƒ€ì… ì‚¬ìš© ê¸ˆì§€\n6. âŒ console.logë¡œ ë””ë²„ê¹…í•˜ì§€ ë§ˆì„¸ìš”\n\n## ì ˆëŒ€ ê¸ˆì§€ ê·œì¹™ (ì—ëŸ¬ ìš°íšŒ)\n7. âŒ || true ë¡œ ëª…ë ¹ ì‹¤íŒ¨ë¥¼ ë¬´ì‹œí•˜ì§€ ë§ˆì„¸ìš”\n8. âŒ || echo 'warning' ìœ¼ë¡œ ì—ëŸ¬ë¥¼ ê²½ê³ ë¡œ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”\n9. âŒ try-catchë¡œ ì—ëŸ¬ë¥¼ ì‚¼í‚¤ì§€ ë§ˆì„¸ìš” (ë°˜ë“œì‹œ ì¬throw ë˜ëŠ” ì ì ˆí•œ ì²˜ë¦¬)\n10. âŒ continue-on-error: true ì‚¬ìš© ê¸ˆì§€\n11. âŒ ë„¤íŠ¸ì›Œí¬/DB ì—°ê²° ì‹¤íŒ¨ë¥¼ ë¬´ì‹œí•˜ê³  ì§„í–‰í•˜ì§€ ë§ˆì„¸ìš”\n12. âŒ fallback ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ìš°íšŒí•˜ì§€ ë§ˆì„¸ìš”\n\n## ì ˆëŒ€ ê¸ˆì§€ ê·œì¹™ (ì¸í”„ë¼)\n13. âŒ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œ --network í”Œë˜ê·¸ë¥¼ ì œê±°í•˜ì§€ ë§ˆì„¸ìš”\n14. âŒ IP ì§ì ‘ í•˜ë“œì½”ë”©ìœ¼ë¡œ DNS/ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ ìš°íšŒ ê¸ˆì§€\n15. âŒ í¬íŠ¸ ì¶©ëŒ ì‹œ ì„ì˜ì˜ ë‹¤ë¥¸ í¬íŠ¸ë¡œ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”\n16. âŒ ê¶Œí•œ ì—ëŸ¬ ì‹œ chmod 777 ë˜ëŠ” --privileged ì‚¬ìš© ê¸ˆì§€\n\n## í—ˆìš©ë˜ëŠ” ìˆ˜ì •\n1. âœ… íƒ€ì… ì •ì˜ ì¶”ê°€/ìˆ˜ì • (interface, type ìƒì„±)\n2. âœ… ëˆ„ë½ëœ import ì¶”ê°€\n3. âœ… ë¡œì§ ë²„ê·¸ ìˆ˜ì • (ì˜¬ë°”ë¥¸ ë¡œì§ìœ¼ë¡œ êµì²´)\n4. âœ… í…ŒìŠ¤íŠ¸ assertion ìˆ˜ì • (ê¸°ëŒ€ê°’ì´ ì˜ëª»ëœ ê²½ìš°)\n5. âœ… ëˆ„ë½ëœ íŒŒì¼/í•¨ìˆ˜ ìƒì„±\n6. âœ… ì˜¬ë°”ë¥¸ íƒ€ì… ìºìŠ¤íŒ… ì¶”ê°€\n7. âœ… null/undefined ì²´í¬ ì¶”ê°€\n\n## ì‘ë‹µ í˜•ì‹ (JSON)\n{\"fixes\": [{\"file\": \"ê²½ë¡œ\", \"description\": \"ì„¤ëª…\", \"changes\": [{\"line_start\": ì¤„, \"line_end\": ì¤„, \"original\": \"ì›ë³¸\", \"replacement\": \"ìˆ˜ì •\"}]}], \"explanation\": \"ìš”ì•½\"}"
              },
              {
                "role": "user",
                "content": "ë‹¤ìŒ ë¹Œë“œ ì—ëŸ¬ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”:\n\n$ERROR_LOG_DECODED"
              }
            ],
            "model": "gpt-4o"
          }
          PAYLOAD_EOF

          # GitHub Copilot API í˜¸ì¶œ (GitHub Models API)
          RESPONSE=$(curl -s -X POST "https://models.github.ai/inference/chat/completions" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d @fix_request.json)

          echo "$RESPONSE" > ai_response.json

          # ì‘ë‹µì—ì„œ ìˆ˜ì • ì‚¬í•­ ì¶”ì¶œ
          if echo "$RESPONSE" | jq -e '.choices[0].message.content' > /dev/null 2>&1; then
            echo "$RESPONSE" | jq -r '.choices[0].message.content' > fix_instructions.json
            echo "has_fix=true" >> $GITHUB_OUTPUT
          else
            echo "AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨"
            cat ai_response.json
            echo "has_fix=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply AI Fixes
        id: apply-fixes
        if: steps.ai-fix.outputs.has_fix == 'true'
        run: |
          # AI ìˆ˜ì • ì‚¬í•­ ì ìš© ìŠ¤í¬ë¦½íŠ¸
          python3 << 'PYTHON_EOF'
          import json
          import os
          import sys

          try:
              with open('fix_instructions.json', 'r') as f:
                  content = f.read()
                  # JSON ë¸”ë¡ ì¶”ì¶œ (ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì²˜ë¦¬)
                  if '```json' in content:
                      content = content.split('```json')[1].split('```')[0]
                  elif '```' in content:
                      content = content.split('```')[1].split('```')[0]
                  fixes = json.loads(content)
          except Exception as e:
              print(f"Failed to parse fix instructions: {e}")
              sys.exit(1)

          applied_count = 0

          for fix in fixes.get('fixes', []):
              file_path = fix.get('file')
              if not file_path or not os.path.exists(file_path):
                  print(f"Skipping {file_path}: file not found")
                  continue

              with open(file_path, 'r') as f:
                  lines = f.readlines()

              for change in fix.get('changes', []):
                  start = change.get('line_start', 1) - 1
                  end = change.get('line_end', start + 1)
                  replacement = change.get('replacement', '')

                  # ë³€ê²½ ì ìš©
                  lines[start:end] = [replacement + '\n']
                  applied_count += 1

              with open(file_path, 'w') as f:
                  f.writelines(lines)

              print(f"Applied fixes to {file_path}")

          print(f"Total fixes applied: {applied_count}")

          # ê²°ê³¼ ì €ì¥
          with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
              f.write(f"applied_count={applied_count}\n")
          PYTHON_EOF

      # =========================================================================
      # ìˆ˜ì • ê²€ì¦ - ì½”ë“œ ì‚­ì œ ê°ì§€
      # =========================================================================
      - name: Validate Fix (No Deletion Check)
        id: validate-fix
        if: steps.apply-fixes.outcome == 'success'
        run: |
          # git diffë¡œ ë³€ê²½ì‚¬í•­ ë¶„ì„
          DIFF=$(git diff --stat)

          # ì‚­ì œëœ ì¤„ ìˆ˜ ê³„ì‚°
          DELETIONS=$(git diff --numstat | awk '{ sum += $2 } END { print sum }')
          ADDITIONS=$(git diff --numstat | awk '{ sum += $1 } END { print sum }')

          echo "Additions: $ADDITIONS"
          echo "Deletions: $DELETIONS"

          # ì‚­ì œê°€ ì¶”ê°€ë³´ë‹¤ ë§ìœ¼ë©´ ê±°ë¶€
          if [ "$DELETIONS" -gt "$ADDITIONS" ]; then
            echo "âŒ Fix rejected: More deletions than additions"
            echo "This violates the no-deletion principle"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # ê¸ˆì§€ íŒ¨í„´ ê²€ì‚¬ (ì½”ë“œ í’ˆì§ˆ)
          if git diff | grep -E "@ts-ignore|@ts-nocheck|eslint-disable|\.skip\(|: any|as any"; then
            echo "âŒ Fix rejected: Contains forbidden code quality patterns"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # ê¸ˆì§€ íŒ¨í„´ ê²€ì‚¬ (ì—ëŸ¬ ìš°íšŒ)
          if git diff | grep -E "\|\| true|\|\| echo|\|\| exit 0|continue-on-error: true|fallback"; then
            echo "âŒ Fix rejected: Contains error bypass patterns"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # ê¸ˆì§€ íŒ¨í„´ ê²€ì‚¬ (ì¸í”„ë¼ ìš°íšŒ)
          if git diff | grep -E "chmod 777|--privileged|[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+"; then
            echo "âŒ Fix rejected: Contains infrastructure bypass patterns"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… Fix validation passed"
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Re-run Build Test
        id: retest
        if: steps.validate-fix.outputs.valid == 'true'
        continue-on-error: true
        run: |
          npm ci
          npm run typecheck 2>&1 || exit 1
          npm run lint 2>&1 || exit 1
          npm run build 2>&1 || exit 1
          npm run test 2>&1 || exit 1
          echo "retest_passed=true" >> $GITHUB_OUTPUT

      - name: Commit Fix
        if: steps.retest.outputs.retest_passed == 'true'
        run: |
          git add -A
          git commit -m "fix: auto-fix build errors

          Applied AI-assisted fixes for build errors.

          Changes:
          - Type definitions added/modified
          - Missing imports added
          - Logic bugs fixed

          ğŸ¤– Generated by Self-Healing CI/CD
          Co-Authored-By: Claude <noreply@anthropic.com>"

          git push origin ${{ github.ref_name }}

      - name: Create Fix Report
        if: always()
        run: |
          echo "## Self-Healing CI/CD Report" > fix_report.md
          echo "" >> fix_report.md
          echo "### Build Status" >> fix_report.md
          echo "- TypeCheck: ${{ needs.build.outputs.typecheck_status || 'N/A' }}" >> fix_report.md
          echo "- Lint: ${{ needs.build.outputs.lint_status || 'N/A' }}" >> fix_report.md
          echo "- Build: ${{ needs.build.outputs.build_status || 'N/A' }}" >> fix_report.md
          echo "- Test: ${{ needs.build.outputs.test_status || 'N/A' }}" >> fix_report.md
          echo "" >> fix_report.md
          echo "### Auto-Fix Results" >> fix_report.md
          echo "- AI Fix Generated: ${{ steps.ai-fix.outputs.has_fix || 'false' }}" >> fix_report.md
          echo "- Fixes Applied: ${{ steps.apply-fixes.outputs.applied_count || '0' }}" >> fix_report.md
          echo "- Validation Passed: ${{ steps.validate-fix.outputs.valid || 'false' }}" >> fix_report.md
          echo "- Re-test Passed: ${{ steps.retest.outputs.retest_passed || 'false' }}" >> fix_report.md

          cat fix_report.md

  # ===========================================================================
  # Job 3: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  # ===========================================================================
  docker:
    name: Build & Push Docker Image
    needs: build
    if: needs.build.outputs.should_auto_fix != 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Job 4: ì„œë²„ ë°°í¬
  # ===========================================================================
  deploy:
    name: Deploy to Server
    needs: [build, docker]
    if: needs.docker.result == 'success' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # ì„œë²„ì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull ë° ë°°í¬
            cd /opt/codeb/projects/${{ github.event.repository.name }}

            # ì´ë¯¸ì§€ pull
            podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            # Rolling ë°°í¬
            podman-compose pull
            podman-compose up -d --remove-orphans

            # í—¬ìŠ¤ì²´í¬
            sleep 10
            curl -f http://localhost:3000/health || exit 1

            echo "âœ… Deployment successful!"

      - name: Notify Success
        if: success()
        run: |
          echo "ğŸš€ Deployment to production completed successfully!"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          # ì—¬ê¸°ì— Slack/Discord ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
