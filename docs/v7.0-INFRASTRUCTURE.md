# CodeB v7.0 인프라스트럭처 가이드

> **버전: 7.0.24** | 업데이트: 2026-01-12

## 개요

CodeB v7.0은 Blue-Green 배포, 실시간 백업, 서버 마이그레이션을 지원하는 완전한 CI/CD 플랫폼입니다.
v7.0에서는 Claude Code 2.1 통합으로 Skills, Hooks, Agent 기반 배포 자동화가 추가되었습니다.

---

## 1. 4-Server Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     CodeB 4-Server Architecture                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │ App Server  │     │  Streaming  │     │   Storage   │       │
│  │ 158.247.    │     │ 141.164.    │     │  64.176.    │       │
│  │   203.55    │     │   42.213    │     │   226.119   │       │
│  │             │     │             │     │             │       │
│  │ • Next.js   │     │ • Centri-   │     │ • Postgres  │       │
│  │ • MCP API   │     │   fugo      │     │ • Redis     │       │
│  │ • Caddy     │     │ • WebSocket │     │             │       │
│  │ • Docker    │     │             │     │             │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│         │                   │                   │               │
│         └───────────────────┼───────────────────┘               │
│                             │                                   │
│                     ┌─────────────┐                             │
│                     │   Backup    │                             │
│                     │ 141.164.    │                             │
│                     │   37.63     │                             │
│                     │             │                             │
│                     │ • ENV 백업  │                             │
│                     │ • WAL 아카  │                             │
│                     │   이브      │                             │
│                     │ • Prometheus│                             │
│                     └─────────────┘                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 서버 역할

| 서버 | IP | 도메인 | 역할 | Docker 서비스 |
|------|-----|--------|------|---------------|
| **App** | 158.247.203.55 | api.codeb.kr | 애플리케이션 | Next.js, Caddy, MCP API:9101, Edge Runtime, GitHub Runner |
| **Streaming** | 141.164.42.213 | ws.codeb.kr | WebSocket | Centrifugo |
| **Storage** | 64.176.226.119 | db.codeb.kr | 데이터베이스 | PostgreSQL, Redis |
| **Backup** | 141.164.37.63 | backup.codeb.kr | 백업/모니터링 | rsync, Prometheus |

---

## 2. 포트 할당

### 포트 범위

| 범위 | 용도 | 예시 |
|------|------|------|
| 3000-3499 | 시스템 서비스 | Dashboard, API, CMS |
| 4000-4499 | 프로덕션 앱 | worb (4000/4001) |
| 4500-4999 | 스테이징 앱 | worb-staging (4500/4501) |
| 5000-5499 | 프리뷰 배포 | PR Preview |
| 5432-5499 | PostgreSQL | 5432 (공용), 5450 (da-rak) |
| 6379-6499 | Redis | 6379 (공용), 6400 (da-rak) |
| 8000 | Centrifugo | WebSocket |
| 9101 | MCP API | HTTP API |

### Blue-Green 포트

| 프로젝트 | Blue | Green |
|----------|------|-------|
| worb (prod) | 4000 | 4001 |
| worb (staging) | 4500 | 4501 |
| w-homepage | 4002 | 4003 |
| da-rak | 4004 | 4005 |

---

## 3. SSOT Registry

### 레지스트리 구조

```
/opt/codeb/registry/
├── ssot.json              # 단일 진실 소스
├── slots/
│   ├── worb-production.json
│   ├── worb-staging.json
│   └── {project}-{env}.json
└── domains/
    └── {project}.json
```

### ssot.json 스키마

```json
{
  "version": "6.0.5",
  "servers": {
    "app": { "host": "158.247.203.55", "role": "application" },
    "storage": { "host": "64.176.226.119", "role": "database" }
  },
  "projects": {
    "worb": {
      "ports": { "production": { "blue": 4000, "green": 4001 } },
      "database": { "name": "worb", "server": "storage" }
    }
  },
  "usedPorts": [3100, 4000, 4001, ...]
}
```

### 슬롯 레지스트리 스키마 (v6.0)

```json
{
  "projectName": "worb",
  "teamId": "default",
  "environment": "production",
  "activeSlot": "blue",
  "blue": {
    "name": "blue",
    "state": "active",
    "port": 4000,
    "version": "v1.2.3",
    "deployedAt": "2026-01-07T00:00:00Z",
    "deployedBy": "key_abc123",
    "promotedAt": "2026-01-07T00:05:00Z",
    "promotedBy": "key_abc123",
    "healthStatus": "healthy"
  },
  "green": {
    "name": "green",
    "state": "deployed",
    "port": 4001,
    "version": "v1.2.4",
    "deployedAt": "2026-01-07T01:00:00Z",
    "deployedBy": "key_abc123",
    "healthStatus": "healthy"
  },
  "lastUpdated": "2026-01-07T01:00:00Z"
}
```

---

## 4. 백업 시스템

### 4.1 PostgreSQL 백업

#### WAL 아카이빙 (실시간)

```bash
# Storage 서버 postgresql.conf
wal_level = replica
archive_mode = on
archive_command = 'rsync -a %p backup.codeb.kr:/opt/codeb/wal-archive/%f'
archive_timeout = 300  # 5분
```

#### 일일 스냅샷

```bash
# 매일 03:00 UTC
0 3 * * * /opt/codeb/scripts/pg-daily-backup.sh
```

### 4.2 Redis 백업

#### AOF (실시간)

```bash
appendonly yes
appendfsync everysec
```

#### RDB 스냅샷

```bash
save 900 1      # 15분 내 1회 변경
save 300 10     # 5분 내 10회 변경
save 60 10000   # 1분 내 10000회 변경
```

### 4.3 ENV 백업

```
/opt/codeb/env-backup/{project}/{environment}/
├── master.env       # 최초 버전 (불변)
├── current.env      # 현재 버전
├── {timestamp}.env  # 변경 이력
└── backup-log.json
```

---

## 5. 배포 파이프라인

### GitHub Actions → MCP API → 서버

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   GitHub     │     │   MCP API    │     │    Server    │
│   Actions    │────▶│  api.codeb.kr│────▶│  App Server  │
└──────────────┘     └──────────────┘     └──────────────┘
       │                    │                    │
       │ 1. Build & Push    │ 2. deploy_project  │ 3. Docker
       │    to GHCR         │    tool call       │    Start
       │                    │                    │
       ▼                    ▼                    ▼
   ┌───────┐           ┌────────┐          ┌─────────┐
   │ Image │           │ Slot   │          │Container│
   │ ghcr. │           │Registry│          │ Running │
   │ io/...│           │ Update │          │         │
   └───────┘           └────────┘          └─────────┘
```

### 배포 워크플로우 (Self-Hosted Runner)

```yaml
# .github/workflows/deploy.yml
name: CodeB Deploy
on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Self-hosted runner 사용 (App 서버)
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and Push
        run: |
          docker build -t ghcr.io/${{ github.repository }}:${{ github.sha }} .
          docker push ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Deploy via MCP API v6.0
        run: |
          curl -sf -X POST "https://api.codeb.kr/api/tool" \
            -H "X-API-Key: ${{ secrets.CODEB_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "tool": "deploy",
              "params": {
                "projectName": "${{ github.event.repository.name }}",
                "environment": "staging",
                "version": "${{ github.sha }}",
                "image": "ghcr.io/${{ github.repository }}:${{ github.sha }}"
              }
            }'
```

### Self-Hosted Runner 구성

| 항목 | 값 |
|------|-----|
| **위치** | App Server (158.247.203.55) |
| **경로** | /opt/actions-runner |
| **사용자** | runner |
| **라벨** | self-hosted, Linux, X64, codeb, app-server |

> **중요**: 모든 워크플로우는 `runs-on: self-hosted`를 사용해야 합니다.

---

## 6. 서버 마이그레이션

### 무중단 마이그레이션 흐름

```
[Source]                           [Target]
    │                                  │
    │  1. 설정 동기화                   │
    │ ─────────────────────────────▶  │
    │                                  │
    │  2. PostgreSQL 복제              │
    │ ─────────────────────────────▶  │
    │                                  │
    │  3. Redis 동기화                 │
    │ ─────────────────────────────▶  │
    │                                  │
    │  4. 컨테이너 시작                 │
    │                                  │ ◀── Ready
    │                                  │
    │  5. DNS 전환                     │
    │ ─────────────────────────────▶  │
    │                                  │
    │  6. Grace Period (48h)           │
    │ ◀─── 롤백 가능                   │
    │                                  │
    └──────── 완료 ────────────────────┘
```

### 마이그레이션 명령

```bash
# 스크립트 실행
/opt/codeb/scripts/server-migration.sh <source_ip> <target_ip>

# Dry-run (실제 변경 없이 확인)
/opt/codeb/scripts/server-migration.sh 158.247.203.55 NEW_IP --dry-run
```

---

## 7. 모니터링

### Prometheus 메트릭

```yaml
scrape_configs:
  - job_name: 'codeb-apps'
    static_configs:
      - targets: ['app.codeb.kr:9101']

  - job_name: 'postgresql'
    static_configs:
      - targets: ['db.codeb.kr:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['db.codeb.kr:9121']
```

### 알림 규칙

```yaml
alerting:
  rules:
    - alert: BackupFailed
      expr: backup_last_success_timestamp < time() - 86400

    - alert: SlotDeployFailed
      expr: codeb_slot_deploy_errors > 0

    - alert: HighMemoryUsage
      expr: container_memory_usage_bytes > 1e9
```

---

## 8. 스크립트 위치

| 스크립트 | 위치 | 용도 |
|----------|------|------|
| setup-postgresql-backup.sh | v6.0/infrastructure/scripts/ | PostgreSQL 백업 설정 |
| setup-redis-backup.sh | v6.0/infrastructure/scripts/ | Redis 백업 설정 |
| init-ssot-registry.sh | v6.0/infrastructure/scripts/ | SSOT 초기화 |
| server-migration.sh | v6.0/infrastructure/scripts/ | 서버 마이그레이션 |
| pg-daily-backup.sh | /opt/codeb/scripts/ (서버) | 일일 PostgreSQL 백업 |
| redis-backup.sh | /opt/codeb/scripts/ (서버) | 시간별 Redis 백업 |

---

## 9. 설정 적용 순서

```bash
# 1. SSOT Registry 초기화 (App 서버)
ssh root@158.247.203.55 "bash /opt/codeb/scripts/init-ssot-registry.sh"

# 2. PostgreSQL 백업 설정 (Storage 서버)
ssh root@64.176.226.119 "bash /opt/codeb/scripts/setup-postgresql-backup.sh"

# 3. Redis 백업 설정 (Storage 서버)
ssh root@64.176.226.119 "bash /opt/codeb/scripts/setup-redis-backup.sh"

# 4. MCP API 재시작
ssh root@158.247.203.55 "cd /opt/codeb/mcp-api-v6 && pkill -f 'node dist' && node dist/index.js &"

# 5. 확인
curl https://api.codeb.kr/health
```

---

## 10. API 키 인증 (v6.0)

### API 키 형식

```
codeb_{teamId}_{role}_{randomToken}

예시:
- codeb_default_admin_a1b2c3d4e5f6g7h8
- codeb_myteam_member_x9y8z7w6v5u4t3s2
```

### 역할 계층

| Role | Level | 권한 |
|------|-------|------|
| **owner** | 4 | 모든 권한 + 팀 삭제 |
| **admin** | 3 | 멤버 관리, 토큰 생성, 슬롯 정리 |
| **member** | 2 | 배포, promote, rollback, ENV 설정 |
| **viewer** | 1 | 조회만 (상태, 로그, 메트릭) |

### API 키 레지스트리

```
/opt/codeb/registry/api-keys.json
```

---

## 관련 문서

- [ARCHITECTURE.md](./ARCHITECTURE.md) - 전체 아키텍처
- [DEPLOYMENT.md](./DEPLOYMENT.md) - 배포 가이드
- [API-REFERENCE.md](./API-REFERENCE.md) - MCP API 레퍼런스
- [VERSION-MANAGEMENT.md](./VERSION-MANAGEMENT.md) - 버전 관리
