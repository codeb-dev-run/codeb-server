# CodeB 3-Layer Infrastructure Architecture

Podman 4.6.2 + Quadlet + systemd ê¸°ë°˜ì˜ ì„œë²„ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ì„¤ê³„ ë¬¸ì„œì…ë‹ˆë‹¤.

## Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         3-Layer Architecture                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Provisioning   â”‚   â”‚  Configuration  â”‚   â”‚    Delivery     â”‚       â”‚
â”‚  â”‚     Layer       â”‚   â”‚     Layer       â”‚   â”‚     Layer       â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚   Terraform     â”‚   â”‚   cloud-init    â”‚   â”‚ GitHub Actions  â”‚       â”‚
â”‚  â”‚   Vultr API     â”‚   â”‚    Ansible      â”‚   â”‚    Quadlet      â”‚       â”‚
â”‚  â”‚   SSH Keys      â”‚   â”‚  Shell Scripts  â”‚   â”‚    systemd      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                     â”‚                     â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                    â–¼                     â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     Target Server                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚    App     â”‚  â”‚ PostgreSQL â”‚  â”‚   Redis    â”‚  â”‚   Caddy    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ Container  â”‚  â”‚ Container  â”‚  â”‚ Container  â”‚  â”‚   Proxy    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                       Podman + Quadlet + systemd                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Layer 1: Provisioning (Terraform)

ì„œë²„ ìƒì„±, ë„¤íŠ¸ì›Œí¬, ë°©í™”ë²½ ë“± ì¸í”„ë¼ í”„ë¡œë¹„ì €ë‹ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### íŒŒì¼ êµ¬ì¡°

```
infrastructure/terraform/
â”œâ”€â”€ main.tf              # ë©”ì¸ ë¦¬ì†ŒìŠ¤ ì •ì˜
â”œâ”€â”€ variables.tf         # ë³€ìˆ˜ ì •ì˜
â”œâ”€â”€ outputs.tf           # ì¶œë ¥ê°’ ì •ì˜
â”œâ”€â”€ terraform.tfvars     # ë³€ìˆ˜ ê°’ (Git ì œì™¸)
â””â”€â”€ scripts/
    â””â”€â”€ cloud-init.yaml  # ì´ˆê¸° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
```

### ì£¼ìš” ê¸°ëŠ¥

```hcl
# ì„œë²„ ì‚­ì œ ë°©ì§€ (ì¤‘ìš”!)
lifecycle {
  prevent_destroy = true
  ignore_changes = [user_data, os_id, plan, ssh_key_ids]
}
```

### ì‚¬ìš©ë²•

```bash
# ì´ˆê¸°í™”
cd infrastructure/terraform
terraform init

# ê¸°ì¡´ ì„œë²„ Import
terraform import vultr_instance.test_server <instance-id>

# ê³„íš í™•ì¸
terraform plan

# ì ìš©
terraform apply
```

## Layer 2: Configuration (cloud-init)

ì„œë²„ ì´ˆê¸° ì„¤ì • ìë™í™”ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### cloud-init ì„¤ì¹˜ í•­ëª©

| êµ¬ì„± ìš”ì†Œ | ë²„ì „ | ëª©ì  |
|----------|------|------|
| Podman | 4.6+ | ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ |
| Quadlet | 4.6+ | systemd í†µí•© |
| Node.js | 20.x | ì•± ëŸ°íƒ€ì„ |
| Caddy | 2.7+ | ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ |
| GitHub CLI | latest | GitHub ì—°ë™ |

### ìë™ ì„¤ì •

- ë°©í™”ë²½ (22, 80, 443, 3000-3999)
- Swap (4GB)
- SSH ë³´ì•ˆ (root íŒ¨ìŠ¤ì›Œë“œ ë¹„í™œì„±í™”)
- Quadlet ë„¤íŠ¸ì›Œí¬ (10.89.0.0/24)

## Layer 3: Delivery (GitHub Actions + Quadlet)

CI/CD íŒŒì´í”„ë¼ì¸ê³¼ ë°°í¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### Hybrid Mode ì›Œí¬í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GitHub Actions Pipeline                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  GitHub-hosted Runner (ubuntu-latest)           â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚   Lint   â”‚â”€â–¶â”‚   Test   â”‚â”€â–¶â”‚  Build   â”‚â”€â–¶â”‚  Push to GHCR    â”‚â”‚â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚ Docker   â”‚  â”‚                  â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  Self-hosted Runner (Server)                    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚ Pull Image   â”‚â”€â–¶â”‚ Update       â”‚â”€â–¶â”‚  Restart Service     â”‚  â”‚â”‚
â”‚  â”‚  â”‚ from GHCR    â”‚  â”‚ Quadlet File â”‚  â”‚  via systemd         â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Quadlet íŒŒì¼ ì˜ˆì‹œ

```ini
# /etc/containers/systemd/myapp.container
[Unit]
Description=MyApp Application
After=network-online.target myapp-postgres.service
Requires=myapp-postgres.service

[Container]
Image=ghcr.io/org/myapp:latest
ContainerName=myapp
PublishPort=3000:3000
Environment=NODE_ENV=production
EnvironmentFile=/opt/codeb/envs/production.env
Network=codeb-network
HealthCmd=curl -sf http://localhost:3000/health || exit 1
HealthInterval=30s
NoNewPrivileges=true

[Service]
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
```

### ë°°í¬ íë¦„

```bash
# 1. GitHub Actionsì—ì„œ ì´ë¯¸ì§€ ë¹Œë“œ â†’ GHCR Push
# 2. Self-hosted runnerì—ì„œ:

# ì´ë¯¸ì§€ Pull
podman pull ghcr.io/org/myapp:latest

# Quadlet íŒŒì¼ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
sed -i 's|^Image=.*|Image=ghcr.io/org/myapp:sha-abc123|' /etc/containers/systemd/myapp.container

# systemd ë¦¬ë¡œë“œ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
systemctl daemon-reload
systemctl restart myapp.service
```

## ë””ë ‰í† ë¦¬ êµ¬ì¡° (ì„œë²„)

```
/opt/codeb/
â”œâ”€â”€ config/                    # ì„¤ì • íŒŒì¼
â”‚   â””â”€â”€ project-registry.json  # í”„ë¡œì íŠ¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬
â”œâ”€â”€ envs/                      # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼
â”‚   â”œâ”€â”€ production.env
â”‚   â””â”€â”€ staging.env
â”œâ”€â”€ data/                      # ë°ì´í„° ë³¼ë¥¨
â”‚   â”œâ”€â”€ myapp/
â”‚   â””â”€â”€ postgres/
â”œâ”€â”€ logs/                      # ë¡œê·¸ ë””ë ‰í† ë¦¬
â”œâ”€â”€ backup/                    # ë°±ì—… ì €ì¥ì†Œ
â””â”€â”€ scripts/                   # ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸
    â”œâ”€â”€ deploy-quadlet.sh
    â””â”€â”€ setup-quadlet-network.sh

/etc/containers/systemd/       # Quadlet ì»¨í…Œì´ë„ˆ ì •ì˜
â”œâ”€â”€ myapp.container
â”œâ”€â”€ myapp-postgres.container
â”œâ”€â”€ myapp-redis.container
â””â”€â”€ codeb.network
```

## CLI ëª…ë ¹ì–´

### ì›Œí¬í”Œë¡œìš° ê´€ë¦¬

```bash
# ìƒˆ í”„ë¡œì íŠ¸ ì›Œí¬í”Œë¡œìš° ì´ˆê¸°í™”
we workflow init myapp

# Quadlet íŒŒì¼ ìƒì„±
we workflow quadlet myapp --port 3000

# GitHub Actions ì›Œí¬í”Œë¡œìš° ìƒì„±
we workflow github-actions myapp

# ì„œë²„ ë°°í¬ ìƒíƒœ ìŠ¤ìº”
we workflow scan myapp

# ê¸°ì¡´ í”„ë¡œì íŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜
we workflow migrate myapp

# Quadlet íŒŒì¼ ì„œë²„ì— ë™ê¸°í™”
we workflow sync myapp

# ì„œë¹„ìŠ¤ ì¶”ê°€ (PostgreSQL/Redis)
we workflow add-service myapp --service postgres
we workflow add-service myapp --service redis

# ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ìˆ˜ì •
we workflow fix-network myapp
```

### ë°°í¬ ëª…ë ¹

```bash
# ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì§ì ‘ ì‹¤í–‰ (ì„œë²„ì—ì„œ)
./scripts/deploy-quadlet.sh myapp production latest
```

## ì¥ì 

### 1. ì•ˆì •ì„±
- **prevent_destroy**: Terraformì—ì„œ ì‹¤ìˆ˜ë¡œ ì„œë²„ ì‚­ì œ ë°©ì§€
- **systemd í†µí•©**: ì„œë²„ ì¬ë¶€íŒ… ì‹œ ìë™ ì‹œì‘
- **Health Check**: ì»¨í…Œì´ë„ˆ ìƒíƒœ ìë™ ëª¨ë‹ˆí„°ë§

### 2. ë³´ì•ˆ
- SSH í‚¤ ê¸°ë°˜ ì¸ì¦ë§Œ í—ˆìš©
- ë°©í™”ë²½ ìë™ ì„¤ì •
- NoNewPrivileges ì»¨í…Œì´ë„ˆ ë³´ì•ˆ

### 3. ìë™í™”
- cloud-initìœ¼ë¡œ ì„œë²„ ì„¤ì • ìë™í™”
- GitHub Actionsìœ¼ë¡œ CI/CD ìë™í™”
- Quadletìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ê´€ë¦¬ ìë™í™”

### 4. DNS ê¸°ë°˜ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬
```
# codeb-network ë‚´ì—ì„œ ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ í†µì‹ 
DATABASE_URL=postgresql://postgres:pass@myapp-postgres:5432/myapp
REDIS_URL=redis://myapp-redis:6379
```

## ì„œë²„ í˜„í™©

| ì„œë²„ | IP | ì—­í•  | ìƒíƒœ |
|------|-----|------|------|
| Test Server | 141.164.60.51 | í…ŒìŠ¤íŠ¸ + ë„¤ì„ì„œë²„ | âœ… ìš´ì˜ ì¤‘ |
| Production Server | TBD | í”„ë¡œë•ì…˜ ì•± | ğŸ”„ ê³„íš ì¤‘ |

## ìš”êµ¬ì‚¬í•­

- Podman 4.4+ (Quadlet ì§€ì›)
- Ubuntu 22.04 LTS
- Terraform 1.0+
- GitHub Actions self-hosted runner (ì„ íƒ)
