# CodeB v7.0 백업 시스템

> **버전: 7.0.0** | 업데이트: 2026-01-11

## 개요

- **목표**: 무중단 실시간 백업 + 서버 마이그레이션 지원
- **최소 부하**: WAL 스트리밍 + 증분 백업
- **롤백 지원**: Blue-Green 배포 시 즉시 롤백 가능
- **감사 로깅**: Claude Code 2.1 Hooks 통합 (v7.0)

---

## 1. 백업 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        백업 흐름도                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                      ┌─────────────┐          │
│  │  Storage    │   WAL 스트리밍        │   Backup    │          │
│  │   Server    │ ────────────────────▶│   Server    │          │
│  │             │   (실시간)            │             │          │
│  │ PostgreSQL  │                      │ WAL Archive │          │
│  │   Redis     │ ────────────────────▶│ RDB + AOF   │          │
│  │             │   매시간 동기화        │             │          │
│  └─────────────┘                      └─────────────┘          │
│        │                                    │                   │
│        │                                    │                   │
│        ▼                                    ▼                   │
│  ┌─────────────┐                      ┌─────────────┐          │
│  │   App       │   ENV 변경 시         │ ENV Backup  │          │
│  │   Server    │ ────────────────────▶│ master.env  │          │
│  │             │   자동 백업           │ current.env │          │
│  │ .env files  │                      │ history     │          │
│  └─────────────┘                      └─────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. PostgreSQL 백업

### 2.1 WAL 아카이빙

WAL(Write-Ahead Logging)은 모든 데이터 변경을 로그로 기록하여 실시간 복구를 지원합니다.

```bash
# Storage 서버 postgresql.conf
wal_level = replica          # WAL 레벨 설정
archive_mode = on            # 아카이빙 활성화
archive_command = 'rsync -a %p backup.codeb.kr:/opt/codeb/wal-archive/%f'
archive_timeout = 300        # 5분마다 강제 아카이브
max_wal_senders = 3          # 최대 복제 연결
wal_keep_size = 1GB          # WAL 보관 크기
```

### 2.2 스트리밍 복제 (선택적)

Backup 서버를 Standby로 설정하여 실시간 복제:

```bash
# Backup 서버 - Standby 설정
primary_conninfo = 'host=db.codeb.kr port=5432 user=replicator password=xxx'
restore_command = 'cp /opt/codeb/wal-archive/%f %p'
```

### 2.3 일일 스냅샷

```bash
# /opt/codeb/scripts/pg-daily-backup.sh
#!/bin/bash
DATE=$(date +%Y-%m-%d)
BACKUP_DIR="/opt/codeb/db-backup/postgresql"

for DB in codeb worb workb da_rak; do
  pg_dump -U codeb -Fc $DB > $BACKUP_DIR/$DB-$DATE.dump
done

# 7일 보관
find $BACKUP_DIR -name "*.dump" -mtime +7 -delete

# Backup 서버로 동기화
rsync -avz $BACKUP_DIR/ backup.codeb.kr:/opt/codeb/db-backup/postgresql/
```

### 2.4 복구 절차

```bash
# 특정 시점으로 복구 (Point-in-Time Recovery)
pg_restore -U codeb -d worb -c /backup/worb-2026-01-07.dump

# WAL 기반 복구 (특정 시간까지)
recovery_target_time = '2026-01-07 10:00:00'
```

---

## 3. Redis 백업

### 3.1 AOF (Append Only File)

모든 쓰기 명령을 로그로 기록:

```bash
# redis.conf
appendonly yes              # AOF 활성화
appendfsync everysec        # 1초마다 fsync (성능/안정성 균형)
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

### 3.2 RDB 스냅샷

주기적으로 메모리 스냅샷 저장:

```bash
# redis.conf
save 900 1      # 15분 내 1회 변경 시
save 300 10     # 5분 내 10회 변경 시
save 60 10000   # 1분 내 10000회 변경 시

dir /data
dbfilename dump.rdb
```

### 3.3 백업 스크립트

```bash
# /opt/codeb/scripts/redis-backup.sh (매시간 실행)
#!/bin/bash
DATE=$(date +%Y-%m-%d-%H%M)
BACKUP_DIR="/opt/codeb/db-backup/redis"

# RDB 스냅샷 강제 생성
redis-cli BGSAVE
sleep 5

# 백업 복사
cp /data/dump.rdb $BACKUP_DIR/dump-$DATE.rdb
cp /data/appendonly.aof $BACKUP_DIR/appendonly-$DATE.aof

# Backup 서버로 동기화
rsync -avz /data/dump.rdb backup.codeb.kr:/opt/codeb/db-backup/redis/current.rdb
```

### 3.4 복구 절차

```bash
# RDB에서 복구
redis-cli SHUTDOWN
cp /backup/dump-2026-01-07.rdb /data/dump.rdb
redis-server /etc/redis.conf

# AOF에서 복구
redis-check-aof --fix /backup/appendonly.aof
cp /backup/appendonly.aof /data/appendonly.aof
redis-server /etc/redis.conf
```

---

## 4. ENV 백업

### 4.1 백업 구조

```
/opt/codeb/env-backup/{project}/{environment}/
├── master.env           # 최초 생성 시 저장 (불변, 복구 기준)
├── current.env          # 현재 버전
├── 2026-01-07T10:30:00.env  # 변경 이력
├── 2026-01-06T15:20:00.env
└── backup-log.json      # 변경 로그
```

### 4.2 백업 트리거

1. `we env set` 명령 실행 시
2. 배포 시 ENV 변경 감지
3. 매일 자동 스냅샷

### 4.3 복구 명령

```bash
# master.env에서 복구 (권장)
we env restore myapp --version master

# current.env에서 복구
we env restore myapp --version current

# 특정 시점으로 복구
we env restore myapp --version 2026-01-06T15:20:00

# 백업 목록 확인
we env backups myapp
```

---

## 5. Blue-Green 배포와 백업 연동

### 5.1 배포 시 스냅샷 저장 (v6.0)

```json
{
  "projectName": "worb",
  "teamId": "default",
  "activeSlot": "blue",
  "blue": {
    "name": "blue",
    "state": "active",
    "version": "v1.2.3",
    "deployedBy": "key_abc123",
    "dbSnapshot": "worb-2026-01-07T10:00.dump",
    "redisSnapshot": "worb-2026-01-07T10:00.rdb",
    "envBackup": "2026-01-07T10:00:00.env"
  },
  "green": {
    "name": "green",
    "state": "grace",
    "version": "v1.2.2",
    "deployedBy": "key_abc123",
    "dbSnapshot": "worb-2026-01-06T10:00.dump"
  },
  "lastUpdated": "2026-01-07T10:00:00Z"
}
```

### 5.2 롤백 시 DB 복구

```bash
# 롤백만 (트래픽 전환)
we rollback worb

# 롤백 + DB 복구
we rollback worb --restore-db

# 실행 과정:
# 1. Green 슬롯 활성화
# 2. Green 슬롯의 dbSnapshot 복구 (선택적)
# 3. ENV 복구 (선택적)
```

---

## 6. 백업 모니터링

### 6.1 Prometheus 메트릭

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'backup-status'
    static_configs:
      - targets: ['backup.codeb.kr:9090']
```

### 6.2 알림 규칙

```yaml
alerting:
  rules:
    - alert: BackupFailed
      expr: backup_last_success_timestamp < time() - 86400
      labels:
        severity: critical
      annotations:
        summary: "백업 실패 (24시간 이상)"

    - alert: WALArchiveLag
      expr: pg_stat_archiver_archived_count < 1
      for: 1h
      annotations:
        summary: "WAL 아카이브 지연"

    - alert: RedisAOFDisabled
      expr: redis_aof_enabled == 0
      annotations:
        summary: "Redis AOF 비활성화"
```

### 6.3 백업 상태 API

```bash
# 백업 상태 조회 (v6.0 API Key 형식: codeb_{teamId}_{role}_{token})
curl -X POST https://api.codeb.kr/api/tool \
  -H "X-API-Key: codeb_default_viewer_xxxxx" \
  -H "Content-Type: application/json" \
  -d '{"tool": "backup_status", "params": {"project": "worb"}}'

# 응답
{
  "postgresql": {
    "lastSnapshot": "2026-01-07T03:00:00Z",
    "walArchived": 156,
    "replicationLag": "0 bytes"
  },
  "redis": {
    "aofEnabled": true,
    "lastRdbSave": "2026-01-07T05:00:00Z",
    "aofSize": "128MB"
  },
  "env": {
    "lastBackup": "2026-01-07T05:30:00Z",
    "versions": 5
  }
}
```

---

## 7. 백업 저장소

### 7.1 Backup 서버 디렉토리

```
/opt/codeb/
├── wal-archive/           # PostgreSQL WAL 아카이브
│   ├── 000000010000000000000001
│   └── ...
├── db-backup/
│   ├── postgresql/        # PostgreSQL 일일 스냅샷
│   │   ├── codeb-2026-01-07.dump
│   │   └── worb-2026-01-07.dump
│   └── redis/             # Redis 백업
│       ├── current.rdb
│       └── current.aof
└── env-backup/            # ENV 백업
    ├── worb/
    │   ├── production/
    │   └── staging/
    └── da-rak/
```

### 7.2 보관 정책

| 유형 | 보관 기간 | 저장 위치 |
|------|----------|----------|
| WAL 아카이브 | 7일 | Backup 서버 |
| PostgreSQL 스냅샷 | 7일 | Backup 서버 |
| Redis RDB | 24시간 (시간별) | Backup 서버 |
| Redis AOF | 최신 1개 | Backup 서버 |
| ENV 백업 | 무제한 | Backup 서버 |
| ENV master.env | 영구 | Backup 서버 |

---

## 8. 설정 스크립트 실행

```bash
# 1. PostgreSQL 백업 설정 (Storage 서버)
ssh root@64.176.226.119
bash /opt/codeb/scripts/setup-postgresql-backup.sh

# 2. Redis 백업 설정 (Storage 서버)
bash /opt/codeb/scripts/setup-redis-backup.sh

# 3. 크론 작업 확인
crontab -l

# 4. 백업 테스트
/opt/codeb/scripts/pg-daily-backup.sh
/opt/codeb/scripts/redis-backup.sh
```

---

## 관련 문서

- [v6.0-INFRASTRUCTURE.md](./v6.0-INFRASTRUCTURE.md) - 인프라 가이드
- [DEPLOYMENT.md](./DEPLOYMENT.md) - 배포 가이드
- [API-REFERENCE.md](./API-REFERENCE.md) - MCP API 레퍼런스
